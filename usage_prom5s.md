# Использование prom5s (prometheus)

## **Prom5s** производит сбор, хранение, анализ и отображение метрик о работе:

* хоста (сервера) - NodeExporter
* docker сервиса и контейнеров - cAdvisor
* СУБД PostgreSQL - Postgres_exporter

Метрики экспортеров собираются и хранятся в БД [Prometheus](http://prometheus.io), доступ через www сервис - ссылка на cis сервисе dcape: `www-prom5s`.
Также [Prometheus](http://prometheus.io) анализирует метрики и рассылает предупреждения на e-mail или сервисы типа Slack о различных событиях (достижение значением установленного порога, прогнозируемое достижение значения и т.п.).
Подробная документация по работе с [Prometheus](https://prometheus.io/docs/introduction/overview/)

Метики из БД [Prometheus](http://prometheus.io) отображаются на приборных панелях [Grafana](http://grafana.io), доступ через www сервис - ссылка на cis сервисе dcape: `grafana-prom5s`.
Для доступа - нажать кнопку "Sing Up", заполнить поля.
Смотрите также [информацию](http://docs.grafana.org/tutorials/screencasts/) по работе с панелями Grafana.  

Grafana сохраняет свои настройки иданные в именованном томе "grafana_data". При обновлении не теряются данные метрик. Но при необходимости смены паролей, нужно перед обновлением остановить контейнер и убедится в том, что именованый том удален.

## Конфигурирование сервисов

Prometheus
Доступ к www сервису Prometheus осуществляется через traefik. Настройка учетной записи администратора (Prometheus не имеет встроенных механизмов и не поддерживаются сторонние механизмы разделения доступа) производится в переменной: AUTH_PROMETHEUS_ADMIN=[user:hashpassword], хеш пароля задается htaccess.

Grafana
Для доступа к www сервису используется встроенный механизм аутентификации. Для настройки указать данные учетных записей:
GRAFANA_USER
GRAFANA_USER_PASSWORD
GRAFANA_ADMIN_PASSWORD
Логин администратора - admin.

AlertManager
AlertManager производит рассылку уведомлений о событиях (alert) по электронной почте.
Для настройки подключения к SMTP серверу используются:

* EMAIL_ADRESS_FOR_SEND_ALERT - список e-mail адресов, разделенных запятой
* HOSTNAME_SMTP_SERVER - имя хоста сервера
* SMTP_PORT - номер порта
* USERNAME_SMTP_ALERT - имя пользователя для авторизации на сервере SMTP
* PASSWORD_SMTP_ALERT - пароль пользователя

Подключение к SMTP серверу производится без использования TLS.

TODO
Написать шаблоны в Alertmanager для отправки писем с перегрузкой generatorURL (сейчас он содержит имя контейнера/путь к alert) - это ссылка в письме на alert, для установки имени хоста Prometheus вместо имени конетейнера Alertmanager (для конфигурирования это недоступно, якобы можно через шаблоны).

Добавить сбор метрик по использованию жесткого диска составными частями докер (временные файловые системы, используемые и неиспользуемые тома и т.п. - анализ подкаталогов в /var/lib/docker).


## License

The MIT License (MIT), see [LICENSE](LICENSE).

2018 Maxim Danilin <zan@whiteants.net>
